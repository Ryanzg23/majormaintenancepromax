<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MAJOR MAINTENANCE PRO MAX</title>
<link href="favicon.png" rel="shortcut icon" type="image/x-icon">

<style>
* { box-sizing:border-box; }

:root {
  --bg:#f5f5f5;
  --text:#111;
  --card:#ffffff;
  --btn:#2563eb;
  --btn-text:#ffffff;
  --border:#ddd;
  --code-bg:#0f172a;
  --code-text:#e5e7eb;
}

[data-theme="dark"] {
  --bg:#0b1020;
  --text:#e5e7eb;
  --card:#020617;
  --btn:#38bdf8;
  --btn-text:#020617;
  --border:#1e293b;
  --code-bg:#020617;
  --code-text:#e5e7eb;
}

body {
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

.container {
  max-width:1200px;
  margin:auto;
  padding:16px;
}

.report-mode .container {
  max-width:1400px;
}

header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

h1 { margin:0; font-size:20px; }

textarea {
  width:100%;
  min-height:160px;
  padding:12px;
  border-radius:8px;
  border:1px solid var(--border);
  resize:vertical;
}

button, a.btn {
  padding:10px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:var(--btn);
  color:var(--btn-text);
  font-weight:600;
  font-size:13px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  transition:.15s;
}

button:hover:not(:disabled),
a.btn:hover {
  transform:translateY(-1px);
  box-shadow:0 6px 18px rgba(0,0,0,.2);
}

button:disabled {
  opacity:.5;
  cursor:not-allowed;
}

.card {
  background:var(--card);
  padding:15px;
  border-radius:12px;
  margin-top:15px;
}

.actions {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:10px;
}

.actions button { flex:1 1 220px; }

#results { margin-top:28px; }

.domain-card {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  margin-top:20px;
}

.domain-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}

.domain-header h3 {
  margin:0;
  font-size:16px;
  word-break:break-all;
}

.site-preview {
  position:relative;
  margin:12px 0;
}

.site-preview iframe {
  width:100%;
  height:260px;
  border:1px solid var(--border);
  border-radius:10px;
}

.preview-label {
  position:absolute;
  top:8px;
  left:8px;
  background:rgba(0,0,0,.75);
  color:#fff;
  font-size:12px;
  padding:5px 10px;
  border-radius:6px;
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:12px;
  margin-bottom:12px;
}

th, td {
  border:1px solid var(--border);
  padding:6px;
}

th { background:rgba(0,0,0,.05); }

.preview {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
  margin-top:10px;
}

.preview > div {
  display:flex;
  flex-direction:column;
  min-width:0;
}

.code-block {
  background:var(--code-bg);
  color:var(--code-text);
  padding:10px;
  border-radius:8px;
  font-size:11px;
  max-height:220px;
  overflow:auto;
  white-space:pre-wrap;
  word-break:break-word;
}

/* REPORT GRID */
.report-grid {
  display:flex;
  flex-wrap:wrap;
  gap:16px;
}

.report-grid .domain-card {
  width:calc(50% - 8px);
}

/* Report/export: remove buttons */
.report-mode button,
.report-mode a.btn {
  display:none !important;
}

@media (max-width:900px) {
  .preview { grid-template-columns:1fr; }
  .report-grid .domain-card { width:100%; }
}
</style>
</head>

<body data-theme="light">
<div class="container">

<header>
  <h1>MAJOR MAINTENANCE PRO MAX</h1>
  <button id="themeBtn" onclick="toggleTheme()">‚òÄÔ∏è Light</button>
</header>

<div class="card">
<textarea id="urls" placeholder="One domain or URL per line"></textarea>

<div class="actions">
  <button onclick="ampTestAll()">AMP TEST ALL</button>
  <button onclick="pageSpeedAll()">PAGE SPEED ALL</button>
  <button onclick="scanAll()">SCAN ALL</button>
  <button onclick="cssCheckAll()">CHECK ALL CSS</button>
  <button onclick="runSEO()">GENERATE META + ROBOTS</button>
  <button id="reportBtn" onclick="openReport()" disabled>OPEN REPORT PAGE</button>
  <button id="exportBtn" onclick="exportReportHTML()" disabled>
    EXPORT REPORT (HTML)
  </button>
</div>

<div class="status" id="status"></div>
</div>

<div id="results"></div>

</div>

<script>
/* ---------------- UTILITIES ---------------- */

const getUrls = () =>
  document.getElementById("urls").value
    .split("\n")
    .map(u => u.trim())
    .filter(Boolean);

const openWithDelay = (urls, builder, delay = 700) =>
  urls.forEach((u, i) =>
    setTimeout(() => window.open(builder(u), "_blank"), i * delay)
  );

const esc = s =>
  (s || "").replace(/[&<>"']/g, m => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#039;"
  }[m]));

/* ---------------- BULK TOOLS ---------------- */

function ampTestAll() {
  openWithDelay(getUrls(), u =>
    `https://search.google.com/test/amp?url=${encodeURIComponent(u)}`
  );
}

function pageSpeedAll() {
  openWithDelay(getUrls(), u =>
    `https://pagespeed.web.dev/report?url=${encodeURIComponent(u)}`
  );
}

function scanAll() {
  openWithDelay(getUrls(), u =>
    `https://sitecheck.sucuri.net/results/${encodeURIComponent(u)}`
  );
}

function cssCheckAll() {
  openWithDelay(getUrls(), u =>
    `https://jigsaw.w3.org/css-validator/validator?uri=${encodeURIComponent(u)}`
  );
}

/* ---------------- REDIRECT FORMATTER ---------------- */

function formatRedirect(chain, finalUrl) {
  // Normalize domain (remove protocol + www)
  const normalizeDomain = url =>
    url.replace(/^https?:\/\//, "").replace(/^www\./, "").split("/")[0];

  const finalDomain = normalizeDomain(finalUrl);

  // No redirects at all
  if (!chain || chain.length === 0) {
    return `<strong>${finalUrl}</strong>`;
  }

  // Check if ALL redirects stay on the same domain
  const sameDomainOnly = chain.every(step =>
    normalizeDomain(step.url) === finalDomain
  );

  // Same domain redirects (http/https/www changes only)
  if (sameDomainOnly) {
    return `<strong>${finalUrl}</strong>`;
  }

  // Redirects to a DIFFERENT domain
  if (chain.length === 1) {
    return `301 to <strong>${finalUrl}</strong>`;
  }

  const middle = chain
    .slice(0, -1)
    .map(r => r.url)
    .join(" ‚Üí ");

  return `301 to ${middle} ‚Üí <strong>${finalUrl}</strong>`;
}


/* ---------------- MAIN SEO FUNCTION ---------------- */

async function runSEO() {
  const urls = getUrls();
  const results = document.getElementById("results");
  const status = document.getElementById("status");

  reportBtn.disabled = true;
  exportBtn.disabled = true;
  results.innerHTML = "";

  for (let i = 0; i < urls.length; i++) {
    status.textContent = `Processing ${i + 1} / ${urls.length}`;

    let d;

    try {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 20000);

      const res = await fetch("/.netlify/functions/seo", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url: urls[i] }),
        signal: controller.signal
      });

      clearTimeout(timeout);

      if (!res.ok) throw new Error("Request failed");

      d = await res.json();

    } catch (err) {
      // SAFETY NET ‚Äî DO NOT STOP LOOP
      d = {
        url: urls[i],
        finalUrl: urls[i],
        title: "Failed to load",
        description: "Error fetching data",
        canonical: "-",
        amphtml: "-",
        redirectChain: [],
        robots: { found: false },
        sitemap: { found: false }
      };
    }

    results.innerHTML += `
<div class="domain-card">
  <div class="domain-header">
    <h3>${esc(d.url)}</h3>
    <div>
      <button onclick="togglePreview(this)">Hide Preview</button>
      <a class="btn" href="${d.finalUrl || d.url}" target="_blank">Visit ‚Üó</a>
    </div>
  </div>

  <div class="site-preview">
    <div class="preview-label">Site Preview</div>
    <iframe src="${d.finalUrl || d.url}"></iframe>
  </div>

  <table>
    <tr><th>Title</th><td>${esc(d.title)}</td></tr>
    <tr><th>Description</th><td>${esc(d.description)}</td></tr>
    <tr><th>Canonical</th><td>${d.canonical || "-"}</td></tr>
    <tr><th>AMP</th><td>${d.amphtml || "-"}</td></tr>
    <tr>
      <th>Redirect / Final URL</th>
      <td>${formatRedirect(d.redirectChain, d.finalUrl || d.url)}</td>
    </tr>
  </table>

  <div class="preview">
    <div>
      <strong>Robots.txt</strong>
      <div class="code-block">
        ${d.robots?.found ? esc(d.robots.content) : "robots.txt not found"}
      </div>
    </div>
    <div>
      <strong>Sitemap.xml</strong>
      <div class="code-block">
        ${d.sitemap?.found ? esc(d.sitemap.content) : "sitemap.xml not found"}
      </div>
    </div>
  </div>
</div>`;
  }

  status.textContent = "Done.";
  reportBtn.disabled = false;
  exportBtn.disabled = false;
}


/* ---------------- PREVIEW TOGGLE ---------------- */

function togglePreview(btn) {
  const preview = btn.closest(".domain-card").querySelector(".site-preview");
  const hidden = preview.style.display === "none";
  preview.style.display = hidden ? "" : "none";
  btn.textContent = hidden ? "Hide Preview" : "Show Preview";
}

/* ---------------- REPORT / EXPORT ---------------- */

function buildReportHTML() {
  const content = document.getElementById("results").innerHTML;

  return `
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SEO Report</title>
<link href="favicon.png" rel="shortcut icon" type="image/x-icon">
${document.querySelector("style").outerHTML}
</head>
<body class="report-mode" data-theme="${document.body.dataset.theme}">
<div class="container">
  <h2>SEO Report</h2>
  <div class="report-grid">
    ${content}
  </div>
</div>
</body>
</html>`;
}

function openReport() {
  const win = window.open("", "_blank");
  win.document.write(buildReportHTML());
  win.document.close();
}

function exportReportHTML() {
  const html = buildReportHTML();
  const blob = new Blob([html], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `seo-report-${new Date().toISOString().split("T")[0]}.html`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ---------------- THEME ---------------- */

function toggleTheme() {
  const body = document.body;
  const btn = document.getElementById("themeBtn");

  if (body.dataset.theme === "light") {
    body.dataset.theme = "dark";
    btn.textContent = "üåô Dark";
  } else {
    body.dataset.theme = "light";
    btn.textContent = "‚òÄÔ∏è Light";
  }
}
</script>
  
</body>
</html>






